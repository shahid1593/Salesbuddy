<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Health Alpha Select Premium Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg-offwhite: #f7f7f2;
            --card-bg: #ffffff;
            --text: #1f2937;
            --muted: #6b7280;
            --accent: #1f7a1f;
            --accent-hover: #196519;
            --blue: #1867c0;
            --blue-hover: #14549a;
            --grey: #7a7a7a;
            --grey-hover: #6a6a6a;
            --border: #e5e7eb;
            --pill: #eef2f7;
            --danger: #c62828;
            --ok: #2e7d32;
            --section: #0ea5e9;
            --purple: #7e22ce;
        }

        /* Global Box Sizing Fix */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            /* Ensure you have this image or remove the url() part */
            background: url('bg_pic.jpg') no-repeat center center fixed;
            background-size: cover;
            background-color: var(--bg-offwhite);
            color: var(--text);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.4;
            min-height: 100vh;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 18px 14px 70px;
        }

        /* HEADER & LOGO STYLES */
        header.page-head {
            text-align: center;
            margin: 10px 0 18px;
        }

        header.page-head h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 800;
            text-shadow: 0 1px 3px rgba(255, 255, 255, 0.8);
            color: rgba(125, 28, 125);
        }

        .sbi-logo {
            display: block;
            margin: 0 auto 10px auto;
            max-width: 200px;
            height: auto;
        }

        /* Card & Inputs Styling */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, .045);
        }

        .section-title {
            font-size: 14px;
            font-weight: 800;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .section-title .tag {
            display: inline-flex;
            gap: 8px;
            padding: 6px 10px;
            background: linear-gradient(90deg, rgba(14, 165, 233, .18), rgba(14, 165, 233, 0));
            border-left: 4px solid var(--section);
            border-radius: 8px;
        }

        .section-title .divider {
            flex: 1;
            height: 1px;
            background: var(--border);
            margin-left: 8px;
        }

        /* Input Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(12, minmax(0, 1fr));
            gap: 8px;
        }

        .grid>* {
            min-width: 0;
        }

        .col-6 { grid-column: span 6; }
        .col-12 { grid-column: span 12; }

        @media (max-width:900px) {
            .col-6, .col-12 { grid-column: span 12; }
            .container { padding: 10px }
        }

        label {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 4px;
            display: block;
            font-weight: 600;
        }

        input[type="number"], select, input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: #fff;
            font-size: 13px;
            transition: border-color .2s ease, box-shadow .2s ease;
        }

        input[type="number"]:focus, select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #93c5fd;
        }

        /* TOGGLE BAR STYLES */
        .toggle-wrapper {
            position: relative;
            display: flex;
            background: #f1f5f9;
            border-radius: 99px;
            padding: 4px;
            height: 44px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
            overflow: hidden;
            isolation: isolate;
        }

        .toggle-slider {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 0;
            border-radius: 99px;
            background: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 1;
            pointer-events: none;
        }

        .toggle-option {
            flex: 1;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s ease;
            user-select: none;
            border-radius: 99px;
        }

        .toggle-option:hover { color: #475569; }
        .toggle-option.active { color: var(--blue); font-weight: 700; }

        /* Member row */
        .member-card {
            border: 1px dashed var(--border);
            border-radius: 12px;
            padding: 10px;
        }

        .band-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .band-pill {
            display: inline-block;
            background: var(--pill);
            color: #374151;
            border: 1px solid var(--border);
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 700;
        }

        .error-text {
            font-size: 12px;
            color: var(--danger);
            margin-top: 4px;
        }

        /* Actions */
        .actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding-top: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .btn {
            border: none;
            border-radius: 10px;
            padding: 11px 16px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            background: var(--grey);
            color: #fff;
            transition: transform 0.1s ease, background 0.2s;
        }

        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent); }
        .btn-blue { background: var(--blue); }

        /* WhatsApp Button */
        .btn-whatsapp {
            background: #25D366;
            color: #fff;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-whatsapp:hover { background: #20bd5a; }
        .icon-wa { width: 16px; height: 16px; fill: currentColor; }

        /* RESULT SECTION STYLES */
        #result-section {
            background: white;
            padding: 10px;
            border-radius: 14px;
            border: 2px solid #374151;
            width: 95%;
            max-width: 800px;
            margin: 20px auto;
            overflow: visible;
        }

        .res-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 5px;
            margin-bottom: 8px;
            width: 100%;
        }

        .res-left {
            width: 35%;
            text-align: left;
            font-size: 12px;
            color: rgba(125, 28, 125);
            font-weight: 800;
            line-height: 1.2;
        }

        .res-center {
            width: 30%;
            text-align: center;
            font-size: 16px;
            font-weight: 800;
            text-decoration: underline;
            color: rgba(125, 28, 125);
        }

        .res-right {
            width: 35%;
            display: flex;
            justify-content: flex-end;
        }

        .res-logo {
            max-width: 140px;
            height: auto;
        }

        .premium-box {
            background: rgba(125, 28, 125);
            border: 2px dashed #000;
            border-radius: 8px;
            padding: 5px;
            text-align: center;
            margin-bottom: 5px;
        }

        .premium-title {
            font-size: 12px;
            font-weight: 700;
            color: #fdfffe;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .premium-amount {
            font-size: 18px;
            font-weight: 900;
            color: #fdfffe;
            margin: 1px 0;
        }

        .discount-info {
            color: #fdfffe;
            font-size: 9px;
            font-weight: 600;
        }

        .result-table {
            width: 100%;
            margin: 0 auto 3px auto;
            table-layout: fixed;
            border-collapse: collapse;
        }

        .result-table th, .result-table td {
            padding: 1px 4px;
            border: 1px solid #9ca3af;
            font-size: 9px;
            line-height: 1.2;
            vertical-align: middle;
        }

        .result-table th {
            background-color: #f3f4f6;
            color: #111827;
            font-weight: 700;
            width: 45%;
            text-align: left;
            height: 18px;
        }

        .result-table td {
            color: #1f2937;
            width: 55%;
            text-align: left;
            height: 18px;
        }

        #result-section .section-title {
            font-size: 10px;
            margin-bottom: 2px;
            min-height: 16px;
            margin-top: 4px;
        }

        #result-section .section-title .tag { padding: 1px 6px; }

        .disclaimer-note {
            font-size: 8px;
            font-weight: 800;
            font-style: italic;
            color: #555;
            text-align: center;
            margin-top: 8px;
            line-height: 1.1;
        }

        /* Mobile alignment */
        @media (max-width: 600px) {
            .res-left { font-size: 10px; width: 40%; }
            .res-center { font-size: 13px; width: 20%; }
            .res-right { width: 40%; }
            .res-logo { max-width: 100px; }
            #result-section { padding: 8px; margin: 10px auto; width: 95%; }
        }

        /* Print Media - Ensure width is safe for PDF */
        @media print {
            #basic-section, #members-section, #modifiers-section, #optional-section,
            #discounts-section, .actions, #membersError, .primary-actions {
                display: none !important;
            }

            #result-section {
                display: block !important;
                border: 2px solid #374151 !important;
                width: 95% !important;
                margin: 0 auto !important;
                padding: 5px !important;
                box-sizing: border-box !important;
            }

            .result-table th, .result-table td {
                border: 1px solid #000 !important;
                font-size: 8px !important;
                padding: 1px 3px !important;
            }

            .result-actions { display: none !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        
        <header class="page-head">
            <img src="SBI_Logo_New.png" alt="SBI General Insurance" class="sbi-logo">
            <h1>Health Alpha Select Premium Calculator</h1>
        </header>

        <section class="card" id="basic-section">
            <div class="section-title">
                <span class="tag">Basic Details</span>
                <span class="divider"></span>
            </div>
            <div class="grid">
                <div class="col-12">
                    <label>Customer Name</label>
                    <input type="text" id="customerName" placeholder="Enter Customer Name">
                </div>
                <div class="col-6">
                    <label>Sum Insured</label>
                    <select id="sumInsured">
                        <option>5 Lac</option>
                        <option>7.5 Lac</option>
                        <option selected>10 Lac</option>
                        <option>12.5 Lac</option>
                        <option>15 Lac</option>
                        <option>20 Lac</option>
                        <option>25 Lac</option>
                        <option>30 Lac</option>
                        <option>35 Lac</option>
                        <option>50 Lac</option>
                        <option>75 Lac</option>
                        <option>1Cr</option>
                    </select>
                </div>
                <div class="col-6">
                    <label>Policy Type</label>
                    <input type="hidden" id="policyType" value="Individual">
                    <div class="toggle-wrapper">
                        <div class="toggle-slider"></div>
                        <div class="toggle-option active" data-val="Individual">Individual</div>
                        <div class="toggle-option" data-val="Family Floater">Floater</div>
                    </div>
                </div>
                <div class="col-6">
                    <label>Combination</label>
                    <div class="band-wrap" style="gap:6px;">
                        <select id="combination" style="flex:1;">
                            <option>1A</option>
                            <option>2A</option>
                            <option>1A+1C</option>
                            <option>1A+2C</option>
                            <option>1A+3C</option>
                            <option>1A+4C</option>
                            <option>1A+5C</option>
                            <option>2A+1C</option>
                            <option>2A+2C</option>
                            <option>2A+3C</option>
                            <option>2A+4C</option>
                            <option>2A+5C</option>
                        </select>
                        <button class="btn btn-grey" id="genMembersBtn">Generate</button>
                    </div>
                </div>
                <div class="col-6">
                    <label>Zone</label>
                    <input type="hidden" id="zone" value="Zone B">
                    <div class="toggle-wrapper">
                        <div class="toggle-slider"></div>
                        <div class="toggle-option" data-val="Zone A">Zone A</div>
                        <div class="toggle-option active" data-val="Zone B">Zone B</div>
                    </div>
                </div>
                <div class="col-6">
                    <label>Tenure</label>
                    <select id="tenure">
                        <option>1 Year</option>
                    </select>
                </div>
            </div>
        </section>

        <section class="card" id="members-section">
            <div class="section-title">
                <span class="tag">Member Details</span>
                <span class="divider"></span>
            </div>
            <div id="membersWrap" class="grid"></div>
            <div id="membersError" class="error-text" style="display:none;"></div>
        </section>

        <section class="card" id="modifiers-section">
            <div class="section-title">
                <span class="tag">Base Modifiers</span>
                <span class="divider"></span>
            </div>
            <div class="grid">
                <div class="col-6">
                    <label>Room Category</label>
                    <select id="roomCategory">
                        <option>Single Pvt AC Room</option>
                        <option>Twin-Sharing</option>
                        <option>Actuals</option>
                    </select>
                </div>
                <div class="col-6">
                    <label>PED Waiting Period</label>
                    <select id="pedWait">
                        <option>3 Year</option>
                        <option>2 Year</option>
                        <option>1 Year</option>
                    </select>
                </div>
                <div class="col-6">
                    <label>Specific Waiting Period</label>
                    <select id="specWait">
                        <option>2 Year</option>
                        <option>1 Year</option>
                    </select>
                </div>
                <div class="col-6">
                    <label>No Claim Bonus / Discount</label>
                    <select id="ncb">
                        <option>Upto 100%</option>
                        <option>Upto 200%</option>
                        <option>Upto 300%</option>
                        <option>Upto 400%</option>
                        <option>Upto 500%</option>
                        <option>Upto 600%</option>
                        <option>Upto 700%</option>
                        <option>Upto 800%</option>
                        <option>Upto 900%</option>
                        <option>Upto 1000%</option>
                        <option>No Claim Discount</option>
                    </select>
                </div>
            </div>
        </section>

        <section class="card" id="optional-section">
            <div class="section-title">
                <span class="tag">Optional Benefits</span>
                <span class="divider"></span>
            </div>
            <div class="grid">
                <div class="col-6">
                    <label>Consumables</label>
                    <select id="consumables">
                        <option>Not Opted</option>
                        <option>Yes</option>
                        <option>No</option>
                    </select>
                </div>
                <div class="col-6">
                    <label>Health Check-Up</label>
                    <select id="healthCheck">
                        <option>Not Opted</option>
                        <option>Rs.3,000</option>
                        <option>Rs.4,000</option>
                        <option>Rs.5,000</option>
                    </select>
                </div>
                <div class="col-6" id="endlessContainer">
                    <label>Endless Sum Insured</label>
                    <select id="endless">
                        <option>Not Opted</option>
                        <option>Yes</option>
                        <option>No</option>
                    </select>
                </div>
                <div class="col-6">
                    <label>Reconstructive Surgery</label>
                    <select id="reconstructive">
                        <option>Not Opted</option>
                        <option>Yes</option>
                        <option>No</option>
                    </select>
                </div>
                <div class="col-6" id="opdContainer">
                    <label>OPD Coverage</label>
                    <select id="opd">
                        <option>Not Opted</option>
                    </select>
                </div>
                <div class="col-6" id="hospitalCashContainer">
                    <label>Hospital Daily Cash</label>
                    <select id="hospitalCash">
                        <option>Not Opted</option>
                        <option>3 Days</option>
                        <option>5 Days</option>
                        <option>10 Days</option>
                    </select>
                </div>
                <div class="col-6" id="maternityContainer">
                    <label>Maternity Benefit</label>
                    <select id="maternity">
                        <option>Not Opted</option>
                    </select>
                </div>
                <div class="col-6" id="maternityWaitContainer" style="display:none;">
                    <label>Maternity Waiting Period</label>
                    <select id="maternityWait">
                        <option>Choose</option>
                        <option>1 Year</option>
                        <option>2 Years</option>
                        <option>3 Years</option>
                    </select>
                </div>
            </div>
        </section>

        <section class="card" id="discounts-section">
            <div class="section-title">
                <span class="tag">Discounts</span>
                <span class="divider"></span>
            </div>
            <div class="grid">
                <div class="col-6">
                    <label>Welcome Discount</label>
                    <select id="welcomeDisc">
                        <option>No</option>
                        <option>Yes</option>
                    </select>
                </div>
                <div class="col-6">
                    <label>Preferred Network</label>
                    <select id="preferredNetwork">
                        <option>No</option>
                        <option>Yes</option>
                    </select>
                </div>
                <div class="col-6">
                    <label>Girl Child Discount (Auto)</label>
                    <div id="girlChildStatus" class="muted" style="font-size:12px; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff;">Not Applicable</div>
                </div>
            </div>
        </section>

        <div class="actions primary-actions">
            <button id="calcBtn" class="btn btn-primary">Calculate Premium</button>
            <button id="resetBtn" class="btn btn-grey">Reset</button>
        </div>

        <div id="result-section" style="display:none;">
            <div class="res-header-row">
                <div class="res-left">
                    <div>PRODUCT : HEALTH ALPHA</div>
                    <div>VARIANT : SELECT</div>
                </div>
                <div class="res-center"> QUOTE </div>
                <div class="res-right">
                    <img src="SBI_Logo_New.png" alt="SBI General Insurance" class="res-logo">
                </div>
            </div>
            <div class="premium-box">
                <div class="premium-title">Final Premium (0% GST)</div>
                <div id="finalPremium" class="premium-amount">—</div>
                <div class="discount-info">Total Discount Applied: <span id="discountAmt">—</span>
                </div>
            </div>
            <div class="section-title">
                <span class="tag">Quote Details</span>
                <span class="divider"></span>
            </div>
            <table class="result-table">
                <tbody>
                    <tr>
                        <th>Customer Name</th>
                        <td id="infoName"></td>
                    </tr>
                    <tr>
                        <th>Sum Insured</th>
                        <td id="infoSI"></td>
                    </tr>
                    <tr>
                        <th>Policy Type</th>
                        <td id="infoPT"></td>
                    </tr>
                    <tr>
                        <th>Combination</th>
                        <td id="infoCombo"></td>
                    </tr>
                    <tr>
                        <th>Zone / Tenure</th>
                        <td>
                            <span id="infoZone"></span> / <span id="infoTenure"></span>
                        </td>
                    </tr>
                    <tr>
                        <th>Insured Members</th>
                        <td id="infoMembersDetailed"></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-title">
                <span class="tag">Inbuilt Benefits</span>
                <span class="divider"></span>
            </div>
            <table class="result-table">
                <thead>
                    <tr>
                        <th>Benefit</th>
                        <th>Coverage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>In-Patient Treatment</td><td>Upto Sum Insured</td></tr>
                    <tr><td>Day Care Treatment</td><td>Within Sum Insured</td></tr>
                    <tr><td>AYUSH Treatment</td><td>Within Sum Insured</td></tr>
                    <tr><td>Domiciliary Treatment</td><td>Within Sum Insured</td></tr>
                    <tr><td>Pre-hospitalisation</td><td>60 days</td></tr>
                    <tr><td>Post-hospitalisation</td><td>90 days</td></tr>
                    <tr><td>Road Ambulance</td><td>Rs.3,500</td></tr>
                    <tr><td>Radio Cab</td><td>Rs.1,000</td></tr>
                    <tr><td>Bariatric Surgery</td><td>Within Sum Insured</td></tr>
                    <tr><td>Organ Donor</td><td>Upto Sum Insured</td></tr>
                    <tr><td>Modern Treatment</td><td>Upto Sum Insured</td></tr>
                    <tr><td>Convalescence</td><td>Rs.5,000</td></tr>
                    <tr><td>Restore Benefit</td><td>Unlimited</td></tr>
                    <tr><td>E-opinion</td><td>Yes</td></tr>
                </tbody>
            </table>
            <div class="section-title">
                <span class="tag">Base Modifiers Selected</span>
                <span class="divider"></span>
            </div>
            <table class="result-table">
                <tbody>
                    <tr><th>Room Category</th><td id="resRoom"></td></tr>
                    <tr><th>PED Waiting Period</th><td id="resPed"></td></tr>
                    <tr><th>Specific Waiting Period</th><td id="resSpec"></td></tr>
                    <tr><th>No Claim Bonus</th><td id="resNcb"></td></tr>
                </tbody>
            </table>
            <div class="section-title">
                <span class="tag">Optional Features</span>
                <span class="divider"></span>
            </div>
            <table class="result-table">
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Selected Option</th>
                    </tr>
                </thead>
                <tbody id="optionalChosenBody"></tbody>
            </table>
            <div class="disclaimer-note"> *This is for illustration purpose only. Final premium may vary based on any change of age or benefits opted at the time of policy issuance. </div>
            <div class="actions result-actions" data-html2canvas-ignore="true" style="margin-top:20px; border-top:1px solid #e5e7eb; padding-top:15px; display:none;">
                <button id="pdfBtn" class="btn btn-blue">Download Quote</button>
                <button id="waBtn" class="btn btn-whatsapp">
                    <svg class="icon-wa" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" />
                    </svg> WhatsApp </button>
                <button onclick="window.location.reload();" class="btn btn-grey">Reset</button>
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // CALCULATION LOGIC & HELPERS
        // ===========================================
        // Configuration
        const CFG = {
            ROOM_RENT_PCT: { "Single Pvt AC Room": -7.5, "Twin-Sharing": -10.0, "Actuals": 0.0 },
            PRE_HOSP_PCT: 0.0,
            POST_HOSP_PCT: 3.0,
            NCB_LOAD_PCT: {
                "Upto 100%": 0, "Upto 200%": 5, "Upto 300%": 6, "Upto 400%": 7, "Upto 500%": 8,
                "Upto 600%": 9, "Upto 700%": 10, "Upto 800%": 11, "Upto 900%": 12, "Upto 1000%": 13,
                "No Claim Discount": 0
            },
            PED_PCT: { "3 Year": -15.0, "2 Year": 0.0, "1 Year": 30.0 },
            SPECIFIC_PCT: { "2 Year": 0.0, "1 Year": 10.0 },
            AMB_LIMIT_REL: 0.65,
            RADIO_LIMIT_REL: 2.00,
            E_OPINION_PER_MEMBER: 147,
            ORGAN_DONOR_PER_MEMBER(si) {
                if (si <= 1000000) return 15;
                if (si <= 100000000) return 22;
                return 29;
            },
            RESTORE_PCT(si) {
                if (si <= 1000000) return 10.0;
                if (si <= 100000000) return 5.0;
                return 3.0;
            },
            ENDLESS_PCT(si) {
                if (si <= 1000000) return 15.0;
                if (si <= 100000000) return 10.0;
                return 5.0;
            },
            MODERN_TREATMENT_PCT: 0.0,
            CONSUMABLES_PCT: 10.0,
            RECONSTRUCTIVE_PER_MEMBER: 550,
            CONVALESCENCE_PER_MILLE: {
                "0-17": 6.30, "18-25": 4.23, "26-30": 5.27, "31-35": 6.57, "36-40": 11.98,
                "41-45": 14.94, "46-50": 18.63, "51-55": 23.23, "56-60": 28.97, "61-65": 36.13,
                "66-70": 45.05, "71-75": 56.17, "76-80": 70.04, "81-85": 87.34, "85+": 108.91
            },
            HEALTH_CHECK_BASE: { "Rs.3,000": 1468, "Rs.4,000": 1957, "Rs.5,000": 2447 },
            HEALTH_CHECK_REL: (eligible) => {
                if (eligible <= 0) return 0;
                if (eligible === 1) return 1.00;
                if (eligible === 2) return 1.20;
                if (eligible === 3) return 1.50;
                return 1.65;
            },
            FLOATER_TIERS(members) {
                if (members === 2) return 25.0;
                if (members === 3) return 30.0;
                if (members > 3) return 35.0;
                return 0.0;
            },
            NON_FLOATER_END_PCT: 5.0,
            TERM_DISCOUNT_PCT: { '1 Year': 0, '2 Year': 6, '3 Year': 9, '4 Year': 11, '5 Year': 14 },
            ZONE_DISCOUNT(zone) { return zone === 'Zone B' ? 20.0 : 0.0; },
            GIRL_CHILD_PCT: 5.0,
            WELCOME_PCT(yes) { return yes ? 5.0 : 0.0; },
            PREFERRED_NETWORK_PCT(yes) { return yes ? 10.0 : 0.0; },
            MAX_AGG_DISC_PCT: 45.0
        };

        const BASE_PREMIUM_TABLE = {
            cols: ["500000", "750000", "1000000", "1250000", "1500000", "2000000", "2500000", "3000000", "3500000", "5000000", "7500000", "10000000"],
            bands: [
                { label: "0-17", from: 0, to: 17, vals: [5752, 6608, 6893, 7635, 8634, 9776, 10346, 10774, 11202, 12487, 13477, 14333] },
                { label: "18-25", from: 18, to: 25, vals: [5480, 6295, 6567, 7274, 8225, 9312, 9856, 10405, 10813, 12036, 13038, 13853] },
                { label: "26-30", from: 26, to: 30, vals: [6023, 6920, 7219, 7997, 9043, 10239, 10837, 11427, 11875, 13221, 14315, 15212] },
                { label: "31-35", from: 31, to: 35, vals: [6567, 7545, 7872, 8720, 9861, 11166, 11818, 12449, 12938, 14406, 15593, 16571] },
                { label: "36-40", from: 36, to: 40, vals: [8198, 9421, 9829, 10888, 12315, 13946, 14761, 15515, 16126, 17961, 19425, 20648] },
                { label: "41-45", from: 41, to: 45, vals: [10372, 11921, 12438, 13780, 15588, 17653, 18686, 19602, 20377, 22701, 24534, 26084] },
                { label: "46-50", from: 46, to: 50, vals: [13090, 15047, 15699, 17434, 19718, 22327, 23631, 24738, 25716, 28652, 31121, 33078] },
                { label: "51-55", from: 51, to: 55, vals: [17982, 20673, 21570, 23941, 27080, 30668, 32462, 33935, 35280, 39317, 42618, 45309] },
                { label: "56-60", from: 56, to: 60, vals: [22744, 26128, 27256, 30189, 34136, 38648, 40904, 42622, 44313, 49389, 53476, 56860] },
                { label: "61-65", from: 61, to: 65, vals: [32921, 37831, 39468, 43749, 49478, 56025, 59299, 61754, 64209, 71574, 77391, 82302] },
                { label: "66-70", from: 66, to: 70, vals: [46420, 53356, 55667, 61704, 69795, 79042, 83665, 87133, 90600, 101003, 109115, 116050] },
                { label: "71-75", from: 71, to: 75, vals: [62603, 71965, 75086, 83226, 94149, 106632, 112874, 117555, 122237, 136280, 147143, 156506] },
                { label: "76-80", from: 76, to: 80, vals: [84449, 97088, 101301, 112281, 127027, 143880, 152306, 158626, 164945, 183905, 198481, 211121] },
                { label: "81-85", from: 81, to: 85, vals: [113941, 131004, 136692, 151506, 171413, 194164, 205539, 214071, 222602, 248197, 267787, 284851] },
                { label: "85+", from: 86, to: 120, vals: [153755, 176790, 184469, 204458, 231333, 262047, 277404, 288921, 300439, 334992, 361351, 384386] }
            ]
        };

        const PER_MEMBER_AMBULANCE = { "0-17": 21, "18-25": 14, "26-30": 18, "31-35": 22, "36-40": 27, "41-45": 34, "46-50": 43, "51-55": 53, "56-60": 66, "61-65": 83, "66-70": 103, "71-75": 129, "76-80": 161, "81-85": 200, "85+": 250 };
        const PER_MEMBER_RADIO = { "0-17": 24, "18-25": 16, "26-30": 20, "31-35": 25, "36-40": 31, "41-45": 39, "46-50": 49, "51-55": 61, "56-60": 76, "61-65": 95, "66-70": 118, "71-75": 147, "76-80": 183, "81-85": 229, "85+": 285 };
        
        // Hospital Cash Data
        const HOSPITAL_CASH_PREMIUMS = { "0-17": 301, "18-25": 204, "26-30": 257, "31-35": 324, "36-40": 413, "41-45": 517, "46-50": 647, "51-55": 825, "56-60": 1055, "61-65": 1347, "66-70": 1719, "71-75": 2190, "76-80": 2857, "81-85": 4164, "85+": 5950 };
        const HOSPITAL_CASH_REL = { "3 Days": 0.80, "5 Days": 0.85, "10 Days": 0.90 };
        
        // Maternity Data
        const MATERNITY_BASE_PREMIUM = {
            "Rs. 50,000": { "18-35": 12053, "36-45": 10245 },
            "Rs. 75,000": { "18-35": 18079, "36-45": 15368 }
        };
        const MATERNITY_WAIT_REL = { "1 Year": 1.67466666666667, "2 Years": 1.00, "3 Years": 0.80 };
        const CHILD_VACCINATION = 2202;
        const NEW_BORN_COVER = { 1000000: 7388, 1250000: 8183, 1500000: 9253, 2000000: 10476, 2500000: 11088, 3000000: 11706, 3500000: 12164, 5000000: 13540, 7500000: 14668, 10000000: 15585 };
        
        const SI_LABEL_TO_VALUE = {
            "5 Lac": 500000, "7.5 Lac": 750000, "10 Lac": 1000000, "12.5 Lac": 1250000, "15 Lac": 1500000,
            "20 Lac": 2000000, "25 Lac": 2500000, "30 Lac": 3000000, "35 Lac": 3500000, "50 Lac": 5000000,
            "75 Lac": 7500000, "1Cr": 10000000
        };

        const membersWrap = document.getElementById('membersWrap');
        const membersError = document.getElementById('membersError');

        // Helpers
        function ageBandObj(age) {
            for (const b of BASE_PREMIUM_TABLE.bands) {
                if (age >= b.from && age <= b.to) return b;
            }
            return null;
        }

        function ageBandLabel(age) {
            const b = ageBandObj(age);
            return b ? b.label : null;
        }

        function basePremiumFor(age, siVal) {
            const band = ageBandObj(age);
            const idx = BASE_PREMIUM_TABLE.cols.indexOf(String(siVal));
            if (!band || idx < 0) return 0;
            return band.vals[idx];
        }

        function parseCombination(combo) {
            const parts = combo.split('+');
            let adults = 0, children = 0;
            parts.forEach(p => {
                const n = parseInt(p);
                if (p.includes('A')) adults += n || 0;
                if (p.includes('C')) children += n || 0;
            });
            return { adults, children };
        }

        function formatMoney(n) {
            const v = (typeof n === 'number') ? n : parseFloat(n || 0);
            return '₹ ' + Math.round(v).toLocaleString('en-IN');
        }

        // Render Inputs
        function renderMemberRows() {
            const combo = document.getElementById('combination').value;
            const { adults, children } = parseCombination(combo);
            membersWrap.innerHTML = '';
            membersError.style.display = 'none';

            for (let i = 1; i <= adults; i++) {
                const card = document.createElement('div');
                card.className = 'member-card col-12';
                card.innerHTML = `
                    <div class="band-wrap">
                        <span class="band-pill">Adult ${i}</span>
                    </div>
                    <div class="grid">
                        <div class="col-6">
                            <label>Age</label>
                            <input type="number" min="18" max="120" data-role="adult" data-index="${i}" class="age-input" placeholder="e.g., 34"/>
                        </div>
                        <div class="col-6">
                            <label>Gender</label>
                            <select class="gender-input" data-role="adult" data-index="${i}">
                                <option>Male</option>
                                <option>Female</option>
                            </select>
                        </div>
                    </div>`;
                membersWrap.appendChild(card);
            }

            for (let i = 1; i <= children; i++) {
                const card = document.createElement('div');
                card.className = 'member-card col-12';
                card.innerHTML = `
                    <div class="band-wrap">
                        <span class="band-pill">Child ${i}</span>
                    </div>
                    <div class="grid">
                        <div class="col-6">
                            <label>Age</label>
                            <input type="number" min="0" max="25" data-role="child" data-index="${i}" class="age-input" placeholder="≤ 25 yrs"/>
                        </div>
                        <div class="col-6">
                            <label>Gender</label>
                            <select class="gender-input" data-role="child" data-index="${i}">
                                <option>Male</option>
                                <option>Female</option>
                            </select>
                        </div>
                    </div>`;
                membersWrap.appendChild(card);
            }
            
            // Listen for changes in member details
            membersWrap.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('change', updateOptionalVisibility);
                el.addEventListener('input', updateOptionalVisibility);
            });
            updateOptionalVisibility();
        }

        function enforcePolicyCombination() {
            const pt = document.getElementById('policyType').value;
            const comboSel = document.getElementById('combination');
            const genBtn = document.getElementById('genMembersBtn');

            if (pt === 'Individual') {
                comboSel.value = '1A';
                [...comboSel.options].forEach(opt => {
                    opt.hidden = (opt.value !== '1A');
                    opt.disabled = (opt.value !== '1A');
                });
                comboSel.disabled = true;
                genBtn.disabled = false;
            } else {
                [...comboSel.options].forEach(opt => {
                    if (opt.value === '1A') {
                        opt.hidden = true;
                        opt.disabled = true;
                    } else {
                        opt.hidden = false;
                        opt.disabled = false;
                    }
                });
                comboSel.disabled = false;
                if (comboSel.value === '1A') { comboSel.value = '2A'; }
                genBtn.disabled = false;
            }
        }

        function getMembers() {
            const list = [];
            membersWrap.querySelectorAll('.member-card').forEach(card => {
                const ageInp = card.querySelector('.age-input');
                const genderSel = card.querySelector('.gender-input');
                const role = ageInp.getAttribute('data-role');
                const idx = ageInp.getAttribute('data-index');
                const age = parseInt(ageInp.value);
                const gender = genderSel.value;
                list.push({ role, idx, age, gender });
            });
            return list;
        }

        function validateMembers() {
            const inputs = membersWrap.querySelectorAll('.age-input');
            let ok = true;
            inputs.forEach(inp => {
                if (inp.value.trim() === '') {
                    ok = false;
                    inp.style.borderColor = 'var(--danger)';
                } else {
                    inp.style.borderColor = 'var(--border)';
                }
            });
            if (!ok) {
                membersError.style.display = 'block';
                membersError.textContent = 'Age is mandatory for all members.';
                return false;
            }

            const adultAges = membersWrap.querySelectorAll('.age-input[data-role="adult"]');
            let adultInvalid = false;
            adultAges.forEach(inp => {
                const val = parseInt(inp.value);
                if (!isNaN(val) && val < 18) {
                    adultInvalid = true;
                    inp.style.borderColor = 'var(--danger)';
                }
            });
            if (adultInvalid) {
                membersError.style.display = 'block';
                membersError.textContent = 'Minimum age for Adults is 18 years.';
                return false;
            }

            const childAges = membersWrap.querySelectorAll('.age-input[data-role="child"]');
            let childInvalid = false;
            childAges.forEach(inp => {
                const val = parseInt(inp.value);
                if (!isNaN(val) && val > 25) {
                    childInvalid = true;
                    inp.style.borderColor = 'var(--danger)';
                }
            });
            if (childInvalid) {
                membersError.style.display = 'block';
                membersError.textContent = 'Age of Child can be maximum 25 years.';
                return false;
            }

            membersError.style.display = 'none';
            return true;
        }

        function anyDaughter() {
            const childs = membersWrap.querySelectorAll('.gender-input[data-role="child"]');
            for (const c of childs) {
                if (c.value === 'Female') return true;
            }
            return false;
        }

        // DYNAMIC OPTIONAL BENEFITS VISIBILITY
        function updateOptionalVisibility() {
            const siLabel = document.getElementById('sumInsured').value;
            const siVal = SI_LABEL_TO_VALUE[siLabel] || 0;

            // --- OPD LOGIC ---
            const opdSelect = document.getElementById('opd');
            const opdContainer = document.getElementById('opdContainer');
            const currentOpdVal = opdSelect.value;
            opdSelect.innerHTML = '';
            let opdOptions = [];
            if (siVal < 1000000) {
                opdContainer.style.display = 'none';
                opdOptions = ["Not Opted"];
            } else {
                opdContainer.style.display = 'block';
                if (siVal <= 2500000) { opdOptions = ["Not Opted", "Rs. 5,000"]; }
                else { opdOptions = ["Not Opted", "Rs. 10,000", "Rs. 25,000"]; }
            }
            opdOptions.forEach(opt => {
                const el = document.createElement('option');
                el.textContent = opt;
                el.value = opt;
                opdSelect.appendChild(el);
            });
            if (opdOptions.includes(currentOpdVal)) opdSelect.value = currentOpdVal;

            // --- HOSPITAL CASH LOGIC ---
            const cashContainer = document.getElementById('hospitalCashContainer');
            const cashSelect = document.getElementById('hospitalCash');
            if (siVal < 1000000) {
                cashContainer.style.display = 'none';
                cashSelect.value = "Not Opted";
            } else {
                cashContainer.style.display = 'block';
            }

            // --- MATERNITY BENEFIT LOGIC ---
            const matContainer = document.getElementById('maternityContainer');
            const matSelect = document.getElementById('maternity');
            const currentMatVal = matSelect.value;
            
            let hasEligibleFemale = false;
            const members = getMembers();
            for(const m of members) {
                if(m.gender === 'Female' && m.age >= 18 && m.age <= 45) {
                    hasEligibleFemale = true;
                    break;
                }
            }

            matSelect.innerHTML = '';
            let matOptions = [];
            if (siVal < 1000000 || !hasEligibleFemale) {
                matContainer.style.display = 'none';
                matOptions = ["Not Opted"];
            } else {
                matContainer.style.display = 'block';
                if (siVal === 1000000) { matOptions = ["Not Opted", "Rs. 50,000"]; }
                else { matOptions = ["Not Opted", "Rs. 75,000"]; }
            }
            matOptions.forEach(opt => {
                const el = document.createElement('option');
                el.textContent = opt;
                el.value = opt;
                matSelect.appendChild(el);
            });
            if (matOptions.includes(currentMatVal)) matSelect.value = currentMatVal;

            // --- ENDLESS SUM INSURED LOGIC ---
            const endlessContainer = document.getElementById('endlessContainer');
            const endlessSelect = document.getElementById('endless');
            if (siVal < 1000000) {
                endlessContainer.style.display = 'none';
                endlessSelect.value = "Not Opted";
            } else {
                endlessContainer.style.display = 'block';
            }

            // --- MATERNITY WAITING PERIOD LOGIC ---
            const matWaitContainer = document.getElementById('maternityWaitContainer');
            const matWaitSelect = document.getElementById('maternityWait');
            if (matContainer.style.display !== 'none' && matSelect.value !== 'Not Opted') {
                if(matWaitContainer.style.display === 'none') {
                    matWaitSelect.value = "Choose";
                }
                matWaitContainer.style.display = 'block';
            } else {
                matWaitContainer.style.display = 'none';
                matWaitSelect.value = "Choose";
            }
        }

        function calcPremium() {
            const siLabel = document.getElementById('sumInsured').value;
            const siVal = SI_LABEL_TO_VALUE[siLabel];
            const pt = document.getElementById('policyType').value;
            const combo = document.getElementById('combination').value;
            const zone = document.getElementById('zone').value;
            const tenure = document.getElementById('tenure').value;
            const room = document.getElementById('roomCategory').value;
            const pedSel = document.getElementById('pedWait').value;
            const specSel = document.getElementById('specWait').value;
            const ncbSel = document.getElementById('ncb').value;
            const consumables = document.getElementById('consumables').value;
            const healthCheck = document.getElementById('healthCheck').value;
            const endless = document.getElementById('endless').value;
            const reconstructive = document.getElementById('reconstructive').value;
            const welcomeDisc = document.getElementById('welcomeDisc').value === 'Yes';
            const preferredNetwork = document.getElementById('preferredNetwork').value === 'Yes';
            const custName = document.getElementById('customerName').value;
            const opd = document.getElementById('opd').value;
            const hospitalCash = document.getElementById('hospitalCash').value;
            const maternity = document.getElementById('maternity').value;
            const maternityWait = document.getElementById('maternityWait').value;

            if (!validateMembers()) return;

            const { adults, children } = parseCombination(combo);
            const memberCount = adults + children;
            if ((pt === 'Family Floater' || pt === 'Individual Floater') && memberCount < 2) {
                membersError.style.display = 'block';
                membersError.textContent = 'Minimum 2 members required for Floater policies.';
                return;
            }

            const members = getMembers();
            const totalMembers = members.length;
            const eligibleHCCount = members.filter(m => m.age >= 18).length;

            const perMemberBase = members.map(m => {
                const base = basePremiumFor(m.age, siVal);
                const bandLabel = ageBandLabel(m.age);
                return { ...m, base, bandLabel };
            });

            const baseSum = perMemberBase.reduce((s, m) => s + m.base, 0);

            const roomPct = CFG.ROOM_RENT_PCT[room] || 0;
            const prePct = CFG.PRE_HOSP_PCT;
            const postPct = CFG.POST_HOSP_PCT;
            const ncbPct = CFG.NCB_LOAD_PCT[ncbSel] ?? 0;
            const pedPct = CFG.PED_PCT[pedSel] ?? 0;
            const specPct = CFG.SPECIFIC_PCT[specSel] ?? 0;

            const baseWithModifiers = baseSum * (1 + (roomPct + prePct + postPct + ncbPct + pedPct + specPct) / 100);

            const ambulanceAmt = perMemberBase.reduce((s, m) => s + (PER_MEMBER_AMBULANCE[m.bandLabel] || 0) * CFG.AMB_LIMIT_REL, 0);
            const radioCabAmt = perMemberBase.reduce((s, m) => s + (PER_MEMBER_RADIO[m.bandLabel] || 0) * CFG.RADIO_LIMIT_REL, 0);
            const organDonorAmt = CFG.ORGAN_DONOR_PER_MEMBER(siVal) * totalMembers;
            const eOpinionAmt = CFG.E_OPINION_PER_MEMBER * totalMembers;
            const restoreAmt = baseWithModifiers * (CFG.RESTORE_PCT(siVal) / 100);
            const consumablesAmt = (consumables === 'Yes') ? baseWithModifiers * (CFG.CONSUMABLES_PCT / 100) : 0;
            const endlessAmt = (endless === 'Yes') ? baseWithModifiers * (CFG.ENDLESS_PCT(siVal) / 100) : 0;
            const modernAmt = baseWithModifiers * (CFG.MODERN_TREATMENT_PCT / 100);
            const reconstructiveAmt = (reconstructive === 'Yes') ? (CFG.RECONSTRUCTIVE_PER_MEMBER * totalMembers) : 0;

            // OPD Logic
            const OPD_BASE = 9175;
            const OPD_LIMIT_REL = { "Rs. 5,000": 0.30, "Rs. 10,000": 0.60, "Rs. 25,000": 1.00, "Not Opted": 0.0 };
            function getOpdMemberFactor(n) {
                if (n === 1) return 1.00;
                if (n === 2) return 1.20;
                if (n === 3) return 1.40;
                return 1.50; // >3
            }
            let opdAmt = 0;
            if (opd !== "Not Opted") {
                const limitRel = OPD_LIMIT_REL[opd] || 0;
                const memberRel = getOpdMemberFactor(totalMembers);
                const rawOpd = (OPD_BASE * limitRel * memberRel);
                opdAmt = rawOpd * 0.90;
            }

            // Hospital Cash Logic
            let hospitalCashAmt = 0;
            if (hospitalCash !== "Not Opted") {
                const dayRel = HOSPITAL_CASH_REL[hospitalCash] || 0;
                hospitalCashAmt = perMemberBase.reduce((sum, m) => {
                    const agePremium = HOSPITAL_CASH_PREMIUMS[m.bandLabel] || 0;
                    const memberCost = (agePremium * dayRel) * 0.597004515537621;
                    return sum + memberCost;
                }, 0);
            }

            // Maternity Logic
            let maternityTotalAmt = 0;
            if (maternity !== "Not Opted" && maternityWait !== "Choose") {
                const waitRelativity = MATERNITY_WAIT_REL[maternityWait] || 0;
                const newbornCover = NEW_BORN_COVER[siVal] || 0;
                members.forEach(m => {
                    if (m.gender === 'Female' && m.age >= 18 && m.age <= 45) {
                        let ageKey = null;
                        if (m.age >= 18 && m.age <= 35) ageKey = "18-35";
                        else if (m.age >= 36 && m.age <= 45) ageKey = "36-45";
                        
                        if (ageKey) {
                            const baseMatPrem = MATERNITY_BASE_PREMIUM[maternity][ageKey];
                            const memberCost = (baseMatPrem * waitRelativity) + CHILD_VACCINATION + newbornCover;
                            maternityTotalAmt += memberCost;
                        }
                    }
                });
            }

            let step1Subtotal = baseWithModifiers + ambulanceAmt + radioCabAmt + organDonorAmt + eOpinionAmt + restoreAmt + consumablesAmt + endlessAmt + modernAmt + reconstructiveAmt;

            let floaterAmt = 0;
            if (pt === 'Family Floater') {
                floaterAmt = step1Subtotal * (CFG.FLOATER_TIERS(totalMembers) / 100);
                step1Subtotal -= floaterAmt;
            }

            const CONV_LIMIT = 5000;
            const convalescenceAmt = perMemberBase.reduce((s, m) => {
                const rate = CFG.CONVALESCENCE_PER_MILLE[m.bandLabel] || 0;
                return s + (CONV_LIMIT * rate / 1000);
            }, 0);

            let healthCheckAmt = 0;
            if (healthCheck !== 'Not Opted') {
                const baseHC = CFG.HEALTH_CHECK_BASE[healthCheck] || 0;
                const rel = CFG.HEALTH_CHECK_REL(eligibleHCCount);
                healthCheckAmt = Math.round(baseHC * rel);
            }

            const step2Total = step1Subtotal + convalescenceAmt + healthCheckAmt + opdAmt + hospitalCashAmt + maternityTotalAmt;

            let baseForStep3 = step2Total;
            const minBaseAfterCap = step2Total * (1 - CFG.MAX_AGG_DISC_PCT / 100);

            const hasGirlChild = anyDaughter();
            const girlPct = hasGirlChild ? CFG.GIRL_CHILD_PCT : 0;
            
            const gcStatusBox = document.getElementById('girlChildStatus');
            if (hasGirlChild) {
                gcStatusBox.textContent = "Yes";
                gcStatusBox.style.color = "var(--ok)";
                gcStatusBox.style.fontWeight = "800";
                gcStatusBox.style.borderColor = "var(--ok)";
                gcStatusBox.style.background = "#e6f4ea";
            } else {
                gcStatusBox.textContent = "No";
                gcStatusBox.style.color = "var(--muted)";
                gcStatusBox.style.fontWeight = "normal";
                gcStatusBox.style.borderColor = "var(--border)";
                gcStatusBox.style.background = "#fff";
            }

            const termPct = CFG.TERM_DISCOUNT_PCT[tenure] || 0;
            const zonePct = CFG.ZONE_DISCOUNT(zone);
            const welcomePct = CFG.WELCOME_PCT(welcomeDisc);
            const preferredPct = CFG.PREFERRED_NETWORK_PCT(preferredNetwork);

            let discComponents = [
                ["Zone Discount", zonePct],
                ["Girl Child Discount", girlPct],
                ["Preferred Network", preferredPct],
                ["Welcome Discount", welcomePct],
                ["Term Discount", termPct]
            ];

            discComponents.forEach(([name, pct]) => {
                if (pct <= 0) return;
                let intendedAmt = baseForStep3 * (pct / 100);
                let baseAfter = baseForStep3 - intendedAmt;
                if (baseAfter < minBaseAfterCap) {
                    intendedAmt = baseForStep3 - Math.max(minBaseAfterCap, 0);
                    baseAfter = baseForStep3 - intendedAmt;
                }
                baseForStep3 = baseAfter;
            });

            const step3DiscountAmount = step2Total - baseForStep3;
            let finalPremiumNoGST = Math.max(0, baseForStep3);

            // Display Results
            const resultSec = document.getElementById('result-section');
            resultSec.style.display = 'block';
            document.querySelector('.result-actions').style.display = 'flex';
            document.querySelector('.result-actions').style.justifyContent = 'center';

            resultSec.scrollIntoView({ behavior: 'smooth', block: 'start' });

            document.getElementById('finalPremium').textContent = formatMoney(finalPremiumNoGST);
            document.getElementById('discountAmt').textContent = formatMoney(step3DiscountAmount + (pt === 'Family Floater' ? floaterAmt : 0));
            document.getElementById('infoName').textContent = custName || "—";
            document.getElementById('infoSI').textContent = siLabel;
            document.getElementById('infoPT').textContent = pt;
            document.getElementById('infoCombo').textContent = combo;
            document.getElementById('infoZone').textContent = zone;
            document.getElementById('infoTenure').textContent = tenure;
            document.getElementById('resRoom').textContent = room;
            document.getElementById('resPed').textContent = pedSel;
            document.getElementById('resSpec').textContent = specSel;
            document.getElementById('resNcb').textContent = ncbSel;

            const memList = members.map(m => `${m.role.charAt(0).toUpperCase() + m.role.slice(1)} ${m.idx} (${m.age}y ${m.gender})`).join(', ');
            document.getElementById('infoMembersDetailed').textContent = memList;

            const optBody = document.getElementById('optionalChosenBody');
            optBody.innerHTML = '';
            const rows = [
                ["Consumables", consumables, consumablesAmt],
                ["Health Check-Up", healthCheck, healthCheckAmt],
                ["Endless Sum Insured", endless, endlessAmt],
                ["Reconstructive Surgery", reconstructive, reconstructiveAmt],
                ["OPD Coverage", opd, opdAmt],
                ["Hospital Daily Cash", hospitalCash, hospitalCashAmt],
                ["Maternity Benefit", maternity, maternityTotalAmt]
            ];

            if (maternity !== "Not Opted" && maternityWait !== "Choose") {
                rows.push(["Maternity Waiting Period", maternityWait, 0]);
            }

            rows.forEach(([name, status, amt]) => {
                if (status !== 'Not Opted' && status !== 'No') {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${name}</td><td>${status}</td>`;
                    optBody.appendChild(tr);
                }
            });

            if (optBody.children.length === 0) {
                optBody.innerHTML = '<tr><td colspan="2" style="text-align:center; color:#6b7280;">No Optional Benefits Selected</td></tr>';
            }
        }

        // ===========================================
        // EVENT LISTENERS & INIT
        // ===========================================
        document.getElementById('genMembersBtn').addEventListener('click', renderMemberRows);
        document.getElementById('calcBtn').addEventListener('click', calcPremium);
        document.getElementById('resetBtn').addEventListener('click', () => { window.location.reload(); });
        document.getElementById('maternity').addEventListener('change', updateOptionalVisibility);
        document.getElementById('sumInsured').addEventListener('change', updateOptionalVisibility);

        // Toggle Logic
        function initToggles() {
            document.querySelectorAll('.toggle-wrapper').forEach(wrapper => {
                const hiddenInput = wrapper.previousElementSibling;
                const options = wrapper.querySelectorAll('.toggle-option');
                const slider = wrapper.querySelector('.toggle-slider');

                const moveSlider = (targetOption) => {
                    const left = targetOption.offsetLeft;
                    const width = targetOption.offsetWidth;
                    slider.style.transform = `translateX(${left}px)`;
                    slider.style.width = `${width}px`;
                };

                const activeOpt = wrapper.querySelector('.toggle-option.active');
                if (activeOpt) { setTimeout(() => moveSlider(activeOpt), 50); }

                options.forEach(opt => {
                    opt.addEventListener('click', () => {
                        options.forEach(o => o.classList.remove('active'));
                        opt.classList.add('active');
                        moveSlider(opt);
                        const newVal = opt.getAttribute('data-val');
                        hiddenInput.value = newVal;
                        hiddenInput.dispatchEvent(new Event('change'));
                    });
                });

                window.addEventListener('resize', () => {
                    const currentActive = wrapper.querySelector('.toggle-option.active');
                    if (currentActive) moveSlider(currentActive);
                });
            });
        }

        // Initialize
        initToggles();
        ['policyType', 'combination', 'zone', 'tenure'].forEach(id => {
            document.getElementById(id).addEventListener('change', () => {
                if (id === 'policyType') { enforcePolicyCombination(); }
                if (id === 'policyType' || id === 'combination') renderMemberRows();
            });
        });

        // Run these on load
        enforcePolicyCombination();
        renderMemberRows();
        updateOptionalVisibility();

        // ===========================================
        // PDF DOWNLOAD LOGIC
        // ===========================================
        document.getElementById('pdfBtn').addEventListener('click', () => {
            const element = document.getElementById('result-section');
            if (element.style.display === 'none') {
                alert("Please Calculate Premium first.");
                return;
            }
            const opt = {
                margin: [3, 3, 3, 3],
                filename: 'Health_Alpha_Quote.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };
            html2pdf().set(opt).from(element).save();
        });

        // ===========================================
        // WHATSAPP SHARE LOGIC
        // ===========================================
        document.getElementById('waBtn').addEventListener('click', async () => {
            const resultSec = document.getElementById('result-section');
            if (resultSec.style.display === 'none') {
                alert("Please Calculate Premium first before sharing.");
                return;
            }

            // Prepare Message Data
            const custName = document.getElementById('infoName').textContent;
            const premium = document.getElementById('finalPremium').textContent;
            const si = document.getElementById('infoSI').textContent;
            const policyType = document.getElementById('infoPT').textContent;
            const zone = document.getElementById('infoZone').textContent;
            const tenure = document.getElementById('infoTenure').textContent;
            const combination = document.getElementById('infoCombo').textContent;
            const memberData = getMembers();
            const memberAges = memberData.map(m => m.age).join(', ');

            let msg = `*Health Alpha Quote* 🏥\n\n`;
            if (custName && custName !== "—") { msg += `*Customer Name:* ${custName} \n`; }
            msg += `*Final Premium:* ${premium} \n`;
            msg += `-----------------------------\n`;
            msg += `*Sum Insured:* ${si}\n`;
            msg += `*Policy Type:* ${policyType}\n`;
            msg += `*Zone / Tenure:* ${zone} / ${tenure}\n`;
            msg += `*Combination:* ${combination}\n`;
            msg += `*Member Ages:* ${memberAges}\n`;
            msg += `-----------------------------\n`;
            msg += `_Please find the attached quote for more details_`;

            const opt = {
                margin: [3, 3, 3, 3],
                filename: 'Health_Alpha_Quote.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            try {
                const btn = document.getElementById('waBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = 'Generating...';

                const pdfBlob = await html2pdf().set(opt).from(resultSec).output('blob');
                const pdfFile = new File([pdfBlob], "Health_Alpha_Quote.pdf", { type: "application/pdf" });

                if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                    await navigator.share({
                        files: [pdfFile],
                        title: 'Health Alpha Quote',
                        text: msg
                    });
                } else {
                    alert("On desktop, we will download the PDF. Please attach it manually to WhatsApp Web.");
                    const url = URL.createObjectURL(pdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'Health_Alpha_Quote.pdf';
                    a.click();
                    URL.revokeObjectURL(url);
                    setTimeout(() => {
                        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
                    }, 1000);
                }
                btn.innerHTML = originalText;
            } catch (error) {
                console.error("Error sharing:", error);
                alert("Sharing failed or cancelled.");
                document.getElementById('waBtn').innerHTML = originalText || 'WhatsApp';
            }
        });
    </script>
</body>
</html>
